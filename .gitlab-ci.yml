stages:
  - test
  - deploy

variables:
  PY: "3.13"

python3-tests:
  stage: test
  image: $CI_REGISTRY/gdraheim/ci_image_python3:$PY
  before_script:
    - git config --global user.email "superman@example.test"
    - git config --global user.name "Clar Kent Superman"
  script:
    - make style || true
    - make type
    - make teststage
    - find . -name '*.xml'
  artifacts:
    reports:
      junit: "TEST-*.xml"

python3-coverage:
  stage: test
  needs:
    - python3-tests
  image: $CI_REGISTRY/gdraheim/ci_image_python3:$PY
  before_script:
    - git config --global user.email "superman@example.test"
    - git config --global user.name "Clar Kent Superman"
  script:
    - make coverage
    - find . -name '*.xml'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: tmp/coverage.xml
  rules:
    - if: $CI_COMMIT_BRANCH
      when: on_success
    - when: manual

python3-package:
  stage: deploy
  image: $CI_REGISTRY/gdraheim/ci_image_python3:$PY
  variables:
      TWINE_USERNAME: $CI_DEPLOY_USER 
      TWINE_PASSWORD: $CI_DEPLOY_PASSWORD
      REPO: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi"
  script:
    - |
      python3 -m build --version
      python3 -m twine --version
      make pkg
      python3 -m twine upload --repository-url "$REPO"  dist/*
  rules:
    - if: $CI_COMMIT_BRANCH
      when: on_success
    - when: never

docker-pip3-install:
  stage: deploy
  image: docker:cli
  needs:
    - python3-package
  services:
    - docker:dind
  variables:
      DOCKER_LIBRARY: $CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX/library
      REPO: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - |
      TAG=`basename "$CI_COMMIT_BRANCH"`
      [ "$CI_DEFAULT_BRANCH" == "$TAG" ] && TAG="latest"
      { echo "FROM python:$PY" \
      ; echo "RUN python3 -m pip install git_show_bigfiles" \
      ; echo "RUN python3 -m pip show --files git_show_bigfiles" \
      ; echo "RUN python3 -m git_show_bigfiles --version" \
      ; } > Dockerfile
      docker build --pull -t "$CI_REGISTRY_IMAGE:$TAG" .
      docker push "$CI_REGISTRY_IMAGE:$TAG"
  after_script:
      - docker logout $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_BRANCH
      when: on_success
    - when: never
